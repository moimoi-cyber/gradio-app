name: Snyk Security Suite

on:
  pull_request:
    branches: ["main"]     # mainに入る前のチェック（OWASP推奨）
  push:
    branches: ["main"]     # mainを安全に保つ（OWASP推奨）

# --- GitHub の GITHUB_TOKEN の権限設定 ---
permissions:
  contents: read              # リポジトリのコード取得に必要
  security-events: write      # SARIF (解析結果) を GitHub Securityへアップロードするために必要
  actions: read               # 一部のSnykテレメトリ処理で必要


jobs:

  # ==========================================================
  # 1) Snyk Open Source（SCA: ライブラリ脆弱性チェック）
  # ==========================================================
  oss:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4   # リポジトリのコードを取得

      # Python 3.10 を使用し、pip キャッシュを有効化（Gradio想定）
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      # requirements.txt がある場合のみ依存をインストール
      - name: Install dependencies (optional)
        if: hashFiles('requirements*.txt') != ''
        run: pip install -r requirements.txt

      - uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          # High以上の脆弱性はPRを停止
          args: "--sarif-file-output=snyk-oss.sarif --severity-threshold=high"

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-oss.sarif
          category: snyk-sca   # 結果分類のためのラベル


  # ==========================================================
  # 2) Snyk Code（SAST: ソースコードの脆弱性チェック）
  # ==========================================================
  code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: snyk/actions/setup@master

      # High以上の脆弱性があれば停止
      - name: Run Snyk Code
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk code test --severity-threshold=high --sarif > snyk-code.sarif

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif
          category: snyk-code   # 結果分類のためのラベル


  # ==========================================================
  # 3) Snyk Container（コンテナの脆弱性チェック）
  #    ※ いまはDockerイメージ/Dockerfileの準備がない前提で一旦オフ
  # ==========================================================
  # container:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     # image: にスキャンしたいイメージ名
  #     # args: の --file= にはDockerfileのパスを書く
  #     - uses: snyk/actions/docker@master
  #       env:
