
name: Snyk (Free) - SCA / SAST / Secrets / IaC / Container

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: snyk-free-${{ github.ref }}
  cancel-in-progress: true

jobs:
  snyk-free:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Snyk CLI
        uses: snyk/actions/setup@master

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install app dependencies (optional)
        if: ${{ hashFiles('requirements.txt') != '' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Snyk auth
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth $SNYK_TOKEN

      # === SCA ===
      - name: Snyk Open Source (SCA)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
        run: |
          snyk test --file=requirements.txt --package-manager=pip \
            --sarif-file-output=snyk-sca.sarif
          snyk monitor --file=requirements.txt --package-manager=pip

      # === SAST + Secrets ===
      - name: Snyk Code (SAST + Secrets)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
        run: |
          snyk code test --report --sarif-file-output=snyk-code.sarif

      # === IaC ===
      - name: Snyk IaC (Terraform / K8s / CFN configs)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
        run: |
          snyk iac test --sarif-file-output=snyk-iac.sarif

      # === Container ===
      - name: Build Container (only if Dockerfile exists)
        if: ${{ hashFiles('Dockerfile') != '' }}
        run: docker build -t app:latest .

      - name: Snyk Container (image scan)
        if: ${{ hashFiles('Dockerfile') != '' }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
        run: |
          snyk container test app:latest --file=Dockerfile \
            --sarif-file-output=snyk-container.sarif
          snyk container monitor app:latest --file=Dockerfile

      # === Upload SARIF ===
      - name: Upload SARIF (SCA)
        if: ${{ always() && hashFiles('snyk-sca.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-sca.sarif
          category: snyk-sca

      - name: Upload SARIF (Code)
        if: ${{ always() && hashFiles('snyk-code.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif
          category: snyk-code

      - name: Upload SARIF (IaC)
        if: ${{ always() && hashFiles('snyk-iac.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-iac.sarif
          category: snyk-iac

      - name: Upload SARIF (Container)
        if: ${{ always() && hashFiles('snyk-container.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-container.sarif
          category: snyk-container
