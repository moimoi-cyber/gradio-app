name: Snyk Security Suite
on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:

  # -----------------------------------------
  # 1) Snyk Open Source (Python)
  # -----------------------------------------
  oss:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          # 依存ファイルがサブディレクトリにある場合だけ、--file=xxx を追加する必要あり。
          args: --sarif-file-output=snyk-oss.sarif

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-oss.sarif

  # -----------------------------------------
  # 2) Snyk Code (SAST)
  # -----------------------------------------
  code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@master
      - run: snyk code test --sarif > snyk-code.sarif
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif

  # -----------------------------------------
  # 3) Snyk Container (未定 → コメントアウト)
  # -----------------------------------------
  # container:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: snyk/actions/docker@master
  #       continue-on-error: true
  #       env:
  #         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  #       with:
  #         image: # ← ここに入力（例: myapp:latest）
  #         args: --file= # ← ここに Dockerfile パス
  #     - uses: github/codeql-action/upload-sarif@v3
  #       with:
  #         sarif_file: snyk.sarif

  # -----------------------------------------
  # 4) Snyk IaC (Terraform) ← ここは後でパス入力
  # -----------------------------------------
  iac:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/iac@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        # file: infra/terraform   ← パス未定なのでコメントアウト
        # file: # ← 入力後にコメント解除

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk.sarif

  # -----------------------------------------
  # 5) Snyk DAST (未定 → コメントアウト)
  # -----------------------------------------
  # dast:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: Probely/probely-github-action@main
  #       with:
  #         api-key: ${{ secrets.PROBELY_API_KEY }}
  #         target-id: # ← ここに Target ID
  #         region: us # us / eu / au

  # -----------------------------------------
  # 6) SBOM（毎回）
  # -----------------------------------------
  #sbom:
  #  runs-on: ubuntu-latest
  #  steps:
  #    - uses: actions/checkout@v4
  #    - uses: snyk/actions/setup@master
  #    - run: snyk sbom --format=cyclonedx1.6+json --json-file-output=sbom.json
  #      env:
  #        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  #    - uses: actions/upload-artifact@v4
  #      with:
  #        name: sbom
  #        path: sbom.json