name: Snyk Security Suite

on:
  pull_request:
    branches: ["main"]     # mainに入る前のチェック（OWASP推奨）
  push:
    branches: ["main"]     # mainを安全に保つ（OWASP推奨）

# --- GitHub の GITHUB_TOKEN の権限設定 ---
permissions:
  contents: read              # リポジトリのコード取得に必要
  security-events: write      # SARIF (解析結果) をGitHub Securityへアップロードするために必要
  actions: read               # 一部のSnykテレメトリ処理で必要

jobs:

  # ==========================================================
  # 1) Snyk Open Source（SCA: ライブラリ脆弱性チェック）
  #    参考: Snyk Python Action
  #    https://docs.snyk.io/developer-tools/snyk-ci-cd-integrations/github-actions-for-snyk-setup-and-checking-for-vulnerabilities/snyk-python-action  [1](https://github.com/snyk/actions/blob/master/docker/README.md)
  #    - requirements.txt が直下にある場合のみ自動で依存取得→SCAスキャン
  #    - Freeでも試せる（各製品の月間テスト上限あり） https://snyk.io/plans/  [6](https://github.com/garethr/snyk-sbom-examples?search=1)
  # ==========================================================
  oss:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4   # リポジトリのコードを取得

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        # requirements.txt が直下にある時だけ実行（無ければ自動スキップ） 
        if: ${{ hashFiles('requirements.txt') != '' }}
        continue-on-error: true       # スキャン失敗時でも後続（SARIFアップロード）を止めない
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          # High以上の脆弱性を検知した場合にPRを止める設定（任意）
          # （明示したい場合のみ）--file=requirements.txt を追加してもOK
          args: --severity-threshold=high --sarif-file-output=snyk-oss.sarif

      - uses: github/codeql-action/upload-sarif@v4
        if: ${{ hashFiles('requirements.txt') != '' }}
        with:
          sarif_file: snyk-oss.sarif
          category: snyk-sca   # 結果分類のためのラベル
          # 公開Repoは無料でSecurityタブに反映。私有RepoはCode Security有効化等の前提あり（GitHub Docs参照）  [5](https://docs.snyk.io/snyk-api/reference/sbom)


  # ==========================================================
  # 2) Snyk Code（SAST: ソースコードの脆弱性チェック）
  #    参考: Setup Action + CLI（SnykのGitHub Actionsガイド）
  #    https://docs.snyk.io/developer-tools/snyk-ci-cd-integrations/github-actions-for-snyk-setup-and-checking-for-vulnerabilities  [7](https://www.g2.com/products/snyk/pricing)
  #    参考: SARIF→Securityタブ反映の流れ（Snykブログ）
  #    https://snyk.io/blog/snyk-security-information-in-github-code-scanning/  [8](https://www.stackinsight.net/snyk-pricing-guide-2026/)
  #    - マニフェスト不要。リポジトリ内のソースがあれば実行可能
  # ==========================================================
  code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: snyk/actions/setup@master   # CLI導入（Dockerは使わない）
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk Code (CLI)
        continue-on-error: true           # 失敗しても後続（SARIFアップロード）を止めない
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: >
          snyk code test
          # High以上の脆弱性を検知した場合にPRを止める設定（任意）
          --severity-threshold=high
          --sarif-file-output=snyk-code.sarif

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif
          category: snyk-code   # 結果分類のためのラベル


  # ==========================================================
  # 3) Snyk Container（コンテナの脆弱性チェック）
  #    参考: Snyk Docker Action
  #    https://docs.snyk.io/developer-tools/snyk-ci-cd-integrations/github-actions-for-snyk-setup-and-checking-for-vulnerabilities/snyk-docker-action  [2](https://github.com/pricing)
  #    - with: image を指定 / args: --file=Dockerfile を付けると snyk.sarif を生成  [3](https://www.eesel.ai/blog/github-pricing)
  #    【いまはコメントアウト】…Dockerfileとスキャン対象イメージが無い想定のため
  # ==========================================================
  # container:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Build image (optional)
  #       run: docker build -t myapp:latest .
  #
  #     - name: Run Snyk to check Docker image for vulnerabilities
  #       uses: snyk/actions/docker@master
  #       continue-on-error: true
  #       env:
  #         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  #       with:
  #         image: myapp:latest
  #         # High以上の脆弱性を検知した場合にPRを止める設定（任意）
  #         args: --file=Dockerfile --severity-threshold=high
  #
  #     - uses: github/codeql-action/upload-sarif@v4
  #       with:
  #         sarif_file: snyk.sarif
  #         category: snyk-container


  # ==========================================================
  # 4) Snyk IaC（Terraformなどの設定ファイルのチェック）
  #    参考: Snyk Infrastructure as Code Action
  #    https://docs.snyk.io/developer-tools/snyk-ci-cd-integrations/github-actions-for-snyk-setup-and-checking-for-vulnerabilities/snyk-infrastructure-as-code-action  [4](https://qiita.com/comachi/items/3a7e3fa7b49bc18e1547)
  #    【いまはコメントアウト】…with:file で指定する対象（例: infra/terraform）が無い想定
  # ==========================================================
  # iac:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Run Snyk to check configuration files for issues
  #       uses: snyk/actions/iac@master
  #       continue-on-error: true
  #       env:
  #         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  #       with:
  #         file: infra/terraform     # ←対象フォルダ/ファイルを用意できたら有効化
  #         # High以上の脆弱性を検知した場合にPRを止める設定（任意）
  #         args: --severity-threshold=high
  #
  #     - uses: github/codeql-action/upload-sarif@v4
  #       with:
  #         sarif_file: snyk.sarif
  #         category: snyk-iac


  # ==========================================================
  # 5) Snyk DAST（Probely使用）
  #    参考: Probely GitHub Action（外部アクション）
  #    https://github.com/Probely/probely-github-action  [9](https://zenn.dev/comachi/articles/3bc8444ba94dca)
  #    【Snyk Freeでは試せない】…ProbelyはSnykとは別サービスのため、Snyk Freeの範囲外
  # ==========================================================
  # dast:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: Probely/probely-github-action@main
  #       with:
  #         api-key: ${{ secrets.PROBELY_API_KEY }}
  #         target-id: ""    # ←ここにターゲットIDを入力
  #         region: us       # us / eu / au から選ぶ


  # ==========================================================
  # 6) SBOM（ソフトウェア部品表の出力）
  #    参考: SBOM（Snyk APIドキュメントに対応フォーマットの説明あり）
  #    https://docs.snyk.io/snyk-api/reference/sbom  [10](https://docs.snyk.io/developer-tools/snyk-ci-cd-integrations/github-actions-for-snyk-setup-and-checking-for-vulnerabilities/snyk-python-action)
  #    - requirements.txt が直下にある時だけ SBOM を生成（CycloneDX JSON）
  # ==========================================================
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: snyk/actions/setup@master   # CLI導入
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Generate SBOM (CycloneDX JSON via Snyk CLI)
        if: ${{ hashFiles('requirements.txt') != '' }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: >
          snyk sbom
          --format=cyclonedx+json
          --json-file-output=sbom.json

      - uses: actions/upload-artifact@v4
        if: ${{ hashFiles('requirements.txt') != '' }}
        with:
          name: sbom
          path: sbom.json